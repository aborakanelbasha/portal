<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· | Ø¨ÙˆØ§Ø¨Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --panel-bg: rgba(15,23,42,.98);
      --panel-brd: rgba(148,163,184,.7);
      --accent: #38bdf8;
      --text:#f9fafb;
      --muted:#cbd5f5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Segoe UI',system-ui,Tahoma;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color:var(--text);
      padding:20px 12px 60px;
    }
    .container{
      max-width:1100px;
      margin:0 auto;
    }
    h1{
      margin:0 0 8px;
      font-size:1.8rem;
      text-align:right;
    }
    .subtitle{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.95rem;
      text-align:right;
    }
    .user-bar{
      margin:0 0 18px;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(15,23,42,.95), rgba(30,64,175,.92));
      border:1px solid var(--panel-brd);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      box-shadow:0 18px 40px rgba(15,23,42,.8);
      font-size:.9rem;
    }
    .btn{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      padding:6px 12px;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
    }
    .btn:hover{
      box-shadow:0 0 0 1px rgba(56,189,248,.7);
    }
    .panel{
      background:var(--panel-bg);
      border-radius:16px;
      border:1px solid var(--panel-brd);
      padding:14px 14px 10px;
      box-shadow:0 16px 40px rgba(15,23,42,.8);
    }
    .panel-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
      font-size:.9rem;
    }
    .panel-head h2{
      margin:0;
      font-size:1rem;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.8);
      font-size:.8rem;
      background:rgba(15,23,42,.9);
    }
    .badge-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.86rem;
      direction:rtl;
    }
    thead{
      background:rgba(15,23,42,1);
    }
    th,td{
      padding:8px 6px;
      border-bottom:1px solid rgba(51,65,85,.9);
      text-align:right;
      vertical-align:top;
    }
    th{
      font-weight:700;
      color:#e5e7eb;
      position:sticky;
      top:0;
      background:rgba(15,23,42,.98);
      z-index:1;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,.7);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      direction:ltr;
      text-align:left;
    }
    .small{
      font-size:.78rem;
    }
    .empty{
      text-align:center;
      padding:20px 6px;
      color:var(--muted);
      font-size:.9rem;
    }
    .time-cell{
      white-space:nowrap;
    }
    .scroll-wrap{
      max-height:65vh;
      overflow:auto;
      border-radius:10px;
      border:1px solid rgba(30,64,175,.6);
    }
    @media(max-width:700px){
      th:nth-child(1),
      td:nth-child(1){
        display:none;
      }
      .panel-head{
        flex-direction:column;
        align-items:flex-start;
      }
      .user-bar{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="user-bar">
      <div id="userInfo">ğŸ‘‹ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…â€¦</div>
      <div style="display:flex;gap:8px">
        <button type="button" class="btn" onclick="goPortal()">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©</button>
        <button type="button" class="btn" onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      </div>
    </div>

    <h1>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h1>
    <p class="subtitle">
      Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³Ø¬Ù‘ÙÙ„ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
    </p>

    <div class="panel">
      <div class="panel-head">
        <h2>Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©</h2>
        <span id="countBadge" class="badge">
          <span class="badge-dot"></span>
          <span id="eventsCount">0</span> Ø­Ø±ÙƒØ§Øª
        </span>
      </div>

      <div class="scroll-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</th>
              <th>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <tr>
              <td colspan="6" class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·â€¦</td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- ğŸ”— Ø±Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø¨Ù…Ù„Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· (Firebase / Firestore) -->
  <script type="module" src="activity-log.js"></script>

  <script>
    let CURRENT_USER = null;

    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ù€ admin ÙÙ‚Ø·
    (function protectActivityPage(){
      try{
        const raw = localStorage.getItem("aln_session");
        if (!raw){
          alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
          window.location.href = "/";
          return;
        }
        const session = JSON.parse(raw);
        if (!session || !session.username || !session.role){
          localStorage.removeItem("aln_session");
          alert("Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          window.location.href = "/";
          return;
        }

        // Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ®Ù„ÙŠÙ‡Ø§ Ù…ÙØªÙˆØ­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŒ Ø´ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ø¯Ù‡
        if (session.role !== "admin"){
          alert("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (admin) ÙÙ‚Ø·.");
          window.location.href = "/portal";
          return;
        }

        CURRENT_USER = session;
        const userInfo = document.getElementById("userInfo");
        if (userInfo){
          userInfo.textContent = `ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ ${session.username} â€” Ø¯ÙˆØ±Ùƒ: ${session.role}`;
        }
      } catch(e){
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
        window.location.href = "/";
      }
    })();

    function goPortal(){
      window.location.href = "/portal";
    }

    function formatTime(iso){
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("ar-EG");
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Firestore
    async function loadLog(){
      const tbody     = document.getElementById("logBody");
      const countSpan = document.getElementById("eventsCount");

      if (!tbody) return;

      try{
        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† activity-log.js
        let list = await window.fetchActivityLog();

        if (!Array.isArray(list) || !list.length){
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td>
            </tr>`;
          if (countSpan) countSpan.textContent = "0";
          return;
        }

        // Ù†Ø®Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙˆÙ‚
        list = list.slice().reverse();

        tbody.innerHTML = "";
        list.forEach((item, index) => {
          const tr = document.createElement("tr");
          const detailsText = item.details ? JSON.stringify(item.details) : "";

          tr.innerHTML = `
            <td>${index + 1}</td>
            <td class="time-cell">${formatTime(item.time)}</td>
            <td>${item.user || "-"}</td>
            <td>${item.role || "-"}</td>
            <td class="mono small">${item.type || "-"}</td>
            <td class="mono small">${detailsText}</td>
          `;
          tbody.appendChild(tr);
        });

        if (countSpan) countSpan.textContent = String(list.length);
      } catch(err){
        console.error("Error loading activity log:", err);
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·.</td>
          </tr>`;
        if (countSpan) countSpan.textContent = "0";
      }
    }

    // âœ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Firestore
    async function clearLog(){
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
      try{
        await window.clearActivityLog(); // Ù…Ù† activity-log.js
        loadLog();
      } catch(err){
        console.error("Error clearing log:", err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„.");
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadLog();
  </script>
</body>
</html>
