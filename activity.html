<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· | Ø¨ÙˆØ§Ø¨Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{
      --bg: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      --panel: rgba(15,23,42,.92);
      --panel-brd: rgba(148,163,184,.65);
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,.14);
      --text:#f9fafb;
      --muted:#cbd5f5;
      --danger:#f97373;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:'Segoe UI',system-ui,Tahoma;
      background:var(--bg);
      color:var(--text);
      padding:20px 14px 80px;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    .user-bar{
      margin:0 0 20px;
      padding:12px 16px;
      border-radius:16px;
      background:linear-gradient(135deg, rgba(15,23,42,.96), rgba(30,64,175,.95));
      border:1px solid var(--panel-brd);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      box-shadow:0 22px 55px rgba(15,23,42,.9);
      font-size:.9rem;
    }

    .user-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .user-main strong{
      font-size:.95rem;
    }

    .user-meta{
      color:var(--muted);
      font-size:.8rem;
    }

    .user-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.8);
      background:rgba(15,23,42,.9);
      color:var(--text);
      padding:7px 14px;
      cursor:pointer;
      font-weight:600;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn:hover{
      box-shadow:0 0 0 1px rgba(56,189,248,.7);
    }

    .btn-danger{
      border-color:#fecaca;
      background:rgba(127,29,29,.9);
      color:#fee2e2;
    }

    h1{
      margin:0 0 6px;
      font-size:1.9rem;
      text-align:right;
    }

    .subtitle{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.92rem;
      text-align:right;
    }

    .badge-strip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      font-size:.8rem;
      margin-bottom:10px;
    }

    .status-dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background:#22c55e;
    }

    .panel{
      margin-top:8px;
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--panel-brd);
      padding:14px 14px 10px;
      box-shadow:0 20px 55px rgba(15,23,42,.9);
    }

    .panel-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
      font-size:.9rem;
    }

    .panel-head h2{
      margin:0;
      font-size:1rem;
    }

    .count-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--accent-soft);
      border:1px solid rgba(56,189,248,.6);
      font-size:.8rem;
    }

    .count-pill span:first-child{
      font-weight:700;
    }

    .scroll-wrap{
      margin-top:8px;
      max-height:65vh;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(30,64,175,.7);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.84rem;
      direction:rtl;
    }

    thead{
      background:rgba(15,23,42,1);
    }

    th,td{
      padding:8px 6px;
      border-bottom:1px solid rgba(31,41,55,.95);
      text-align:right;
      vertical-align:top;
    }

    th{
      font-weight:700;
      color:#e5e7eb;
      position:sticky;
      top:0;
      background:rgba(15,23,42,.98);
      z-index:1;
    }

    tbody tr:nth-child(even){
      background:rgba(15,23,42,.8);
    }

    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      direction:ltr;
      text-align:left;
    }

    .small{font-size:.78rem;}

    .time-cell{white-space:nowrap;}

    .empty{
      text-align:center;
      padding:24px 8px;
      color:var(--muted);
      font-size:.9rem;
    }

    .error-msg{
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(248,113,113,.8);
      background:rgba(127,29,29,.85);
      color:#fee2e2;
      font-size:.8rem;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      font-size:.75rem;
      background:rgba(15,23,42,.96);
      color:var(--muted);
    }

    .type-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.96);
    }

    .type-pill[data-kind="login"]{
      border-color:#4ade80;
      color:#bbf7d0;
    }
    .type-pill[data-kind="permit"]{
      border-color:#38bdf8;
      color:#bae6fd;
    }
    .type-pill[data-kind="portal"]{
      border-color:#fbbf24;
      color:#fef3c7;
    }

    @media(max-width:780px){
      .user-bar{
        flex-direction:column;
        align-items:flex-start;
      }
      .panel-head{
        flex-direction:column;
        align-items:flex-start;
      }
    }

    @media(max-width:640px){
      body{padding:14px 10px 70px;}
      h1{font-size:1.6rem;}
      .subtitle{font-size:.86rem;}
      th:nth-child(1),
      td:nth-child(1){
        display:none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div class="user-bar">
      <div class="user-main">
        <strong id="userWelcome">ğŸ‘‹ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…â€¦</strong>
        <div class="user-meta" id="userMeta"></div>
      </div>
      <div class="user-actions">
        <button type="button" class="btn" onclick="goPortal()">
          â¬…ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©
        </button>
        <button type="button" class="btn" onclick="clearLocalLog()">
          ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­
        </button>
        <button type="button" class="btn btn-danger" onclick="clearServerLog()">
          âš ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
        </button>
      </div>
    </div>

    <span class="badge-strip">
      <span class="status-dot"></span>
      <span>Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø±ÙƒØ²ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</span>
    </span>

    <h1>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h1>
    <p class="subtitle">
      ØªØ¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø© Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØµØ§Ø±ÙŠØ­
      (ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ØŒ ÙØªØ­ Ø¨ÙˆØ§Ø¨Ø©ØŒ ÙØªØ­ ØªØµØ§Ø±ÙŠØ­ØŒ ØªØ¨Ø¯ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹ØŒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŒ ÙˆØºÙŠØ±Ù‡Ø§).
    </p>

    <div class="panel">
      <div class="panel-head">
        <h2>Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©</h2>
        <div class="count-pill">
          <span id="eventsCount">0</span>
          <span>Ø­Ø±ÙƒØ©</span>
        </div>
      </div>

      <div id="errorBox" class="error-msg" style="display:none;"></div>

      <div class="scroll-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</th>
              <th>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <tr id="emptyRow">
              <td colspan="6" class="empty">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ -->
  <script type="module" src="activity-log.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ù…Ù† Ù†ÙˆØ¹ Ø¹Ø§Ø¯ÙŠ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙˆØ§Ù„ ØªÙƒÙˆÙ† Global Ù„Ù„Ù€ onclick) -->
  <script>
    let CURRENT_USER = null;

    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ù„Ù„Ù€ admin
    (function protectActivityPage(){
      try{
        const raw = localStorage.getItem("aln_session");
        if (!raw){
          alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
          window.location.href = "/";
          return;
        }
        const session = JSON.parse(raw);
        if (!session || !session.username || !session.role){
          localStorage.removeItem("aln_session");
          alert("Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          window.location.href = "/";
          return;
        }

        if ((session.role || "").toLowerCase() !== "admin"){
          alert("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (admin) ÙÙ‚Ø·.");
          window.location.href = "/portal";
          return;
        }

        CURRENT_USER = session;

        const welcomeEl = document.getElementById("userWelcome");
        const metaEl    = document.getElementById("userMeta");
        if (welcomeEl){
          welcomeEl.textContent = `ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ ${session.username} â€” Ø¯ÙˆØ±Ùƒ: ${session.role}`;
        }
        if (metaEl){
          const t = new Date();
          metaEl.textContent = `ØªÙ… ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙÙŠ ${t.toLocaleString("ar-EG")}`;
        }
      } catch(e){
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
        window.location.href = "/";
      }
    })();

    function goPortal(){
      window.location.href = "/portal";
    }

    function formatTime(iso){
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("ar-EG");
    }

    function classifyType(type){
      const t = (type || "").toUpperCase();
      if (t.startsWith("LOGIN") || t === "LOGOUT") return "login";
      if (t.startsWith("PERMIT") || t === "OPEN_PERMIT") return "permit";
      if (t === "PORTAL_OPEN" || t === "SWITCH_PROJECT") return "portal";
      return "";
    }

    async function loadLog(){
      const tbody    = document.getElementById("logBody");
      const emptyRow = document.getElementById("emptyRow");
      const countEl  = document.getElementById("eventsCount");
      const errorBox = document.getElementById("errorBox");

      if (!tbody) return;

      errorBox.style.display = "none";
      errorBox.textContent = "";

      let list = [];

      try{
        if (window.fetchActivityLog){
          list = await window.fetchActivityLog();
        } else {
          const raw = localStorage.getItem("ptw_activity_log");
          list = raw ? (JSON.parse(raw) || []) : [];
        }
      }catch(e){
        console.error("Error loading activity log:", e);
        errorBox.style.display = "block";
        errorBox.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø£ÙŠ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ù…ØªØ§Ø­ (Ø¥Ù† ÙˆØ¬Ø¯).";

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù€ localStorage
        try{
          const raw = localStorage.getItem("ptw_activity_log");
          list = raw ? (JSON.parse(raw) || []) : [];
        }catch(_){}
      }

      if (!Array.isArray(list)) list = [];

      // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      list = list.slice().sort((a,b)=>{
        const ta = a.time || "";
        const tb = b.time || "";
        return ta < tb ? 1 : -1;
      });

      if (!list.length){
        tbody.innerHTML = "";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.</td>`;
        tbody.appendChild(tr);
        if (countEl) countEl.textContent = "0";
        return;
      }

      tbody.innerHTML = "";
      list.forEach((item, index) => {
        const tr = document.createElement("tr");
        const detailsText = item.details ? JSON.stringify(item.details) : "";
        const kind = classifyType(item.type);

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td class="time-cell small mono">${formatTime(item.time)}</td>
          <td class="small">${item.user || "-"}</td>
          <td class="small">
            <span class="tag">
              <span></span>
              <span>${item.role || "-"}</span>
            </span>
          </td>
          <td>
            <span class="type-pill small" data-kind="${kind}">
              ${item.type || "-"}
            </span>
          </td>
          <td class="mono small">${detailsText}</td>
        `;
        tbody.appendChild(tr);
      });

      if (countEl) countEl.textContent = String(list.length);
    }

    async function clearServerLog(){
      if (!window.clearActivityLog){
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù…Ù„Ù activity-log ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
      }
      if (!confirm("âš  Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… (Firestore)ØŸ")) return;

      try{
        await window.clearActivityLog();
        await loadLog();
        alert("ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….");
      }catch(e){
        console.error("clearServerLog error:", e);
        alert("ØªØ¹Ø°Ø± Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.");
      }
    }

    function clearLocalLog(){
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·ØŸ")) return;
      localStorage.removeItem("ptw_activity_log");
      loadLog();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", loadLog);
  </script>
</body>
</html>
