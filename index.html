<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø± - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    ::selection {
      background-color: gray;
    }

    body {
      margin: 0;
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #000;
      color: #fff;
    }

    /* ===== Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===== */
    .hero {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
      background:
        linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)),
        url("https://i.postimg.cc/RVdVFtz0/hero.png") center center / cover no-repeat;
    }

    .hero-card {
      width: min(1100px, 100%);
      display: flex;
      gap: 2rem;
      padding: 2.5rem 2rem;
      border-radius: 24px;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    .hero-left,
    .hero-right {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .hero-left {
      justify-content: center;
      align-items: center;
    }

    /* ===== Ø¬Ø²Ø¡ Ø§Ù„ØªØ±Ø­ÙŠØ¨ ===== */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.25);
      font-size: 0.85rem;
      margin-bottom: 1rem;
      color: #e0e0e0;
    }

    .badge-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #1e90ff;
    }

    .hero-title {
      font-size: 2.2rem;
      margin: 0 0 0.5rem;
    }

    .hero-emoji {
      margin-inline-start: 0.25rem;
    }

    .hero-subtitle {
      font-size: 1rem;
      color: #e0e0e0;
      margin: 0 0 1.5rem;
      line-height: 1.8;
    }

    .hero-footer {
      margin-top: auto;
      font-size: 0.85rem;
      color: #cccccc;
    }

    /* ===== ÙÙˆØ±Ù… Ø§Ù„Ù„ÙˆØ¬ÙŠÙ† ===== */
    .login-container {
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .login-form {
      width: 100%;
      max-width: 400px;
      height: 400px;
      background-image: linear-gradient(to bottom, #424242, #212121);
      display: flex;
      align-items: center;
      flex-direction: column;
      border-radius: 0.5rem;
    }

    .login-title {
      color: wheat;
      margin: 3rem 0 1.5rem;
      font-size: 2rem;
    }

    .login-input {
      margin: 0.5rem 0;
      padding: 1rem 0.5rem;
      width: 24rem;
      max-width: 95%;
      background-color: inherit;
      color: wheat;
      border: none;
      outline: none;
      border-bottom: 1px solid wheat;
      transition: all 400ms;
    }

    .login-input::placeholder {
      color: rgba(245, 222, 179, 0.8);
    }

    .login-input:hover {
      background-color: #424242;
      border: none;
      border-radius: 0.5rem;
    }

    /* ===== Ø§Ù„Ø¹ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ===== */
    .password-wrapper {
      position: relative;
      width: 24rem;
      max-width: 95%;
      margin: 0.5rem 0;
    }

    .password-wrapper .login-input {
      width: 100%;
      padding-inline-end: 2.7rem;
    }

    .password-eye {
      position: absolute;
      inset-inline-end: 1.4rem;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      outline: none;
      transition: transform 80ms ease;
    }

    .eye-icon {
      width: 18px;
      height: 18px;
      stroke: #9ca3af;
      transition: stroke 120ms ease;
    }

    .password-eye.active .eye-icon {
      stroke: #2563eb;
    }

    .password-eye:active {
      transform: translateY(-50%) scale(0.96);
    }

    .login-btn {
      height: 3rem;
      width: 20rem;
      max-width: 90%;
      margin-top: 2rem;
      background-color: wheat;
      border-radius: 0.5rem;
      border: none;
      font-size: 1.2rem;
      transition: all 400ms;
      cursor: pointer;
      box-shadow:
        0 0 10px antiquewhite,
        0 0 10px antiquewhite;
    }

    .login-btn:hover {
      background-color: antiquewhite;
      box-shadow: none;
    }

    .login-error {
      margin-top: 0.8rem;
      font-size: 0.9rem;
      color: #ff8080;
      min-height: 1.2rem;
    }

    .forgot-btn {
      margin-top: 0.6rem;
      background: none;
      border: none;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: underline;
    }

    .forgot-btn:hover {
      color: #bae6fd;
    }

    .signup-link {
      margin-top: 0.4rem;
      background: none;
      border: none;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: underline;
    }

    .signup-link:hover {
      color: #bae6fd;
    }

    /* Ø£ÙˆÙØ±Ù„Ø§ÙŠ ÙÙˆØ±Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
    .signup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .signup-card {
      width: min(420px, 92vw);
      background: rgba(15, 23, 42, 0.98);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      padding: 18px 18px 16px;
      color: #f9fafb;
      text-align: right;
    }

    .signup-card h2 {
      margin: 0 0 6px;
      font-size: 1.1rem;
    }

    .signup-card p {
      margin: 0 0 10px;
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    .signup-card .form-group {
      margin-bottom: 8px;
    }

    .signup-card label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.8rem;
    }

    .signup-card input,
    .signup-card textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-size: 0.86rem;
      resize: vertical;
    }

    .signup-card textarea {
      min-height: 60px;
      max-height: 120px;
    }

    .signup-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      flex-wrap: wrap-reverse;
    }

    .btn-secondary {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .btn-secondary:hover {
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
    }

    .signup-hint {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #94a3b8;
    }

    @media (max-width: 900px) {
      .hero-card {
        flex-direction: column-reverse;
        padding: 1.8rem 1.2rem;
      }

      .hero-right {
        text-align: center;
        align-items: center;
      }

      .hero-footer {
        margin-top: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <section class="hero">
    <div class="hero-card">
      <!-- ===== Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø´Ù…Ø§Ù„: Ø§Ù„Ù„ÙˆØ¬ÙŠÙ† ===== -->
      <div class="hero-left">
        <div class="login-container">
          <form class="login-form" id="login-form">
            <p class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>

            <div class="field-wrapper">
              <input
                placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"
                class="login-input"
                type="text"
                name="username"
                id="username"
                autocomplete="username"
                required
              />
            </div>

            <div class="field-wrapper password-wrapper">
              <input
                placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                class="login-input"
                type="password"
                name="password"
                id="password"
                autocomplete="current-password"
                required
              />
              <button
                type="button"
                id="togglePassword"
                class="password-eye"
                aria-label="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªÙ‹Ø§"
              >
                <svg class="eye-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M2.5 12C4 8.5 7.5 6 12 6s8 2.5 9.5 6c-1.5 3.5-5 6-9.5 6s-8-2.5-9.5-6z"
                    fill="none"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <circle
                    cx="12"
                    cy="12"
                    r="3"
                    fill="none"
                    stroke-width="1.8"
                  />
                </svg>
              </button>
            </div>

            <button class="login-btn" type="submit">Ø¯Ø®ÙˆÙ„</button>

            <button type="button" id="forgotPasswordBtn" class="forgot-btn">
              Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
            </button>

            <button
              type="button"
              id="openSignup"
              class="signup-link">
              Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
            </button>

            <p class="login-error" id="login-error"></p>
          </form>
        </div>
      </div>

      <!-- ===== Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„ØªØ±Ø­ÙŠØ¨ ===== -->
      <div class="hero-right">
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø± â€” Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†</span>
        </div>

        <h1 class="hero-title">
          Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ <span class="hero-emoji">ğŸ‘‹</span>
        </h1>

        <p class="hero-subtitle">
          Ø³ÙŠÙØ³Ø¬Ù‘ÙÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªØµØ§Ø±ÙŠØ­ØŒ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ÙˆØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª
          <strong>PDF</strong> Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ù†Ø¬Ø±Ø§Ù† ÙˆØ´Ø±ÙˆØ±Ø©) Ø­Ø³Ø¨ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ.
        </p>

        <div class="hero-footer">
          Eng. Ahmed El-Basha Â©
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ===== -->
  <div id="signupOverlay" class="signup-overlay" style="display:none;">
    <div class="signup-card">
      <h2>Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
      <p>
        Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚ÙØ¨ÙÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….
      </p>

      <form id="signupForm">
        <div class="form-group">
          <label for="su_username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­</label>
          <input id="su_username" type="text" required />
        </div>

        <div class="form-group">
          <label for="su_email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="su_email" type="email" required />
        </div>

        <div class="form-group">
          <label for="su_phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="su_phone" type="text" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
        </div>

        <div class="form-group">
          <label for="su_password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label>
          <input id="su_password" type="password" required />
          <div class="signup-hint">
            ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨.
          </div>
        </div>

        <div class="form-group">
          <label for="su_message">Ø±Ø³Ø§Ù„Ø© ØªØ¹Ø±ÙŠÙÙŠØ© / Ø³Ø¨Ø¨ Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„</label>
          <textarea
            id="su_message"
            placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­ØªØ§Ø¬ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØªØµØ§Ø±ÙŠØ­ Ù…Ø´Ø±ÙˆØ¹ Ù†Ø¬Ø±Ø§Ù† ÙƒÙ…Ø´Ø±Ù Ø³Ù„Ø§Ù…Ø©."></textarea>
        </div>

        <div class="signup-actions">
          <button type="submit" class="login-btn" style="margin-top:0;">
            Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </button>
          <button type="button" id="closeSignup" class="btn-secondary">
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </form>

      <p class="signup-hint">
        * Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚ÙØ¨ÙÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙˆØ³ØªØµÙ„Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.
      </p>
    </div>
  </div>

  <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø¹Ø§Ù…: Ø§Ù„Ù€ UI + Ø¬Ù„Ø³Ø© Ù‚Ø¯ÙŠÙ…Ø© + Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ¬ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… -->
  <script>
    // ===== Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø«Ø§Ø¨Øª Ù„Ùˆ Ø§Ù„Ù€ ptw_users Ù…Ø´ Ù…ØªØ¸Ø¨Ø· =====
    const FALLBACK_USERS = {
      admin: { password: "Admin@123", role: "admin", active: true }
    };

    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (users.html)
    function readStoredUsers() {
      try {
        const raw = localStorage.getItem("ptw_users");
        if (!raw) return [];
        const list = JSON.parse(raw);
        return Array.isArray(list) ? list : [];
      } catch (e) {
        console.error("ptw_users parse error", e);
        return [];
      }
    }

    const form = document.getElementById("login-form");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const errorBox = document.getElementById("login-error");
    const togglePasswordBtn = document.getElementById("togglePassword");

    // Ø§Ù„Ø¹ÙŠÙ† â€“ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¶ØºØ· ÙÙ‚Ø·
    function showPasswordTemp() {
      passwordInput.type = "text";
      togglePasswordBtn.classList.add("active");
    }

    function hidePassword() {
      passwordInput.type = "password";
      togglePasswordBtn.classList.remove("active");
    }

    if (togglePasswordBtn) {
      togglePasswordBtn.addEventListener("mousedown", (e) => {
        e.preventDefault();
        showPasswordTemp();
      });

      togglePasswordBtn.addEventListener("mouseup", (e) => {
        e.preventDefault();
        hidePassword();
      });

      togglePasswordBtn.addEventListener("mouseleave", hidePassword);

      togglePasswordBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        showPasswordTemp();
      });

      togglePasswordBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        hidePassword();
      });

      togglePasswordBtn.addEventListener("touchcancel", hidePassword);
    }

    // Ù„Ùˆ ÙÙŠÙ‡ Ø¬Ù„Ø³Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¯Ø®Ù‘Ù„ Ø¹Ù„Ù‰ Ø·ÙˆÙ„
    (function autoRedirectIfLoggedIn() {
      try {
        const stored = localStorage.getItem("aln_session");
        if (!stored) return;
        const session = JSON.parse(stored);
        if (session && session.username && session.role) {
          window.location.href = "portal.html";
        }
      } catch (e) {
        console.warn("Session parse error", e);
      }
    })();

    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ¬ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… (ptw_users + FALLBACK) =====
    window.legacyLoginAttempt = function legacyLoginAttempt(username, password) {
      if (!errorBox) return false;
      errorBox.textContent = "";

      const cleanUser = (username || "").trim();
      const pass = password || "";

      if (!cleanUser || !pass) {
        errorBox.textContent = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        return false;
      }

      const usersList = readStoredUsers();
      let foundUser = null;

      // Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† FALLBACK Ø¯Ø§ÙŠÙ…Ø§Ù‹
      if (cleanUser === "admin" && FALLBACK_USERS.admin) {
        const fb = FALLBACK_USERS.admin;
        foundUser = {
          username: "admin",
          password: fb.password,
          role: fb.role,
          active: fb.active ?? true
        };
      } else {
        foundUser = usersList.find(u => (u.username || "").toLowerCase() === cleanUser.toLowerCase());

        if (!foundUser && FALLBACK_USERS[cleanUser]) {
          const fb = FALLBACK_USERS[cleanUser];
          foundUser = {
            username: cleanUser,
            password: fb.password,
            role: fb.role,
            active: fb.active ?? true
          };
        }
      }

      if (!foundUser) {
        errorBox.textContent = "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
        return false;
      }

      if (foundUser.active === false) {
        errorBox.textContent = "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚ÙˆÙ. Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
        return false;
      }

      if (!foundUser.password || foundUser.password !== pass) {
        errorBox.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return false;
      }

      const sessionData = {
        username: foundUser.username,
        role: foundUser.role || "najran",
        loginTime: new Date().toISOString()
      };

      localStorage.setItem("aln_session", JSON.stringify(sessionData));
      window.location.href = "portal.html";
      return true;
    };
  </script>

  <!-- Ø³ÙƒØ±ÙŠØ¨Øª Firebase: username/email -> Firebase Auth + Ù†Ø³ÙŠØª Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ + Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ -->
 <script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyDXQW3_6iFkb8Ec2aaVtFMJZYxLN-FmI54",
    authDomain: "ptw-najran-sharurah.firebaseapp.com",
    projectId: "ptw-najran-sharurah",
    storageBucket: "ptw-najran-sharurah.firebasestorage.app",
    messagingSenderId: "848619550286",
    appId: "1:848619550286:web:fe5c470f67236b2519751f"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„ÙˆØ¬ÙŠÙ†
  const formEl   = document.getElementById("login-form");
  const userEl   = document.getElementById("username");
  const passEl   = document.getElementById("password");
  const errorEl  = document.getElementById("login-error");
  const forgotBtn = document.getElementById("forgotPasswordBtn");

  // Ø¯ÙˆØ§Ù„ Ù…Ù† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ window)
  // legacyLoginAttempt Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙÙˆÙ‚

  // ===== Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ptw_users Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ role ÙˆØ§Ù„Ù€ email =====
  function readStoredUsers() {
    try {
      const raw = localStorage.getItem("ptw_users");
      if (!raw) return [];
      const list = JSON.parse(raw);
      return Array.isArray(list) ? list : [];
    } catch (e) {
      console.error("ptw_users parse error", e);
      return [];
    }
  }

  function findUserByIdentifier(identifier) {
    const list = readStoredUsers();
    if (!identifier) return null;

    if (identifier.includes("@")) {
      return list.find(
        (u) => (u.email || "").toLowerCase() === identifier.toLowerCase()
      );
    } else {
      return list.find(
        (u) => (u.username || "").toLowerCase() === identifier.toLowerCase()
      );
    }
  }

  // ===== Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
  if (formEl) {
    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.textContent = "";

      const identifier = (userEl.value || "").trim(); // username Ø£Ùˆ Ø¥ÙŠÙ…ÙŠÙ„
      const password   = passEl.value || "";

      if (!identifier || !password) {
        errorEl.textContent = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        return;
      }

      // 1) Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ â†’ Ù†Ø³ÙŠØ¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
      if (!identifier.includes("@") && identifier === "admin") {
        window.legacyLoginAttempt(identifier, password);
        return;
      }

      // 2) Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Firebase
      let loginEmail = identifier;
      let appUser    = null;

      if (!identifier.includes("@")) {
        appUser = findUserByIdentifier(identifier);
        if (!appUser || !appUser.email) {
          errorEl.textContent =
            "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø¥ÙŠÙ…ÙŠÙ„. Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.";
          return;
        }
        loginEmail = appUser.email;
      } else {
        // identifier Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø¥ÙŠÙ…ÙŠÙ„
        appUser = findUserByIdentifier(identifier) || null;
      }

      try {
        const cred   = await signInWithEmailAndPassword(auth, loginEmail, password);
        const fbUser = cred.user;
        console.log("Firebase login OK:", fbUser);

        if (appUser && appUser.active === false) {
          errorEl.textContent = "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚ÙˆÙ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
          return;
        }

        if (!appUser) {
          const list = readStoredUsers();
          appUser =
            list.find(
              (u) =>
                (u.email || "").toLowerCase() === (fbUser.email || "").toLowerCase()
            ) || null;
        }

        const sessionData = {
          uid: fbUser.uid,
          email: fbUser.email,
          username: appUser?.username || fbUser.email,
          role: appUser?.role || "admin", // ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙŠÙÙˆÙ„Øª Ø¨Ø¹Ø¯ÙŠÙ†
          loginTime: new Date().toISOString()
        };

        localStorage.setItem("aln_session", JSON.stringify(sessionData));
        window.location.href = "portal.html";
      } catch (err) {
        console.error("Firebase login error:", err);
        let handled = false;

        if (!identifier.includes("@")) {
          // Ù†Ø¬Ø±Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒÙ€ fallback
          handled = window.legacyLoginAttempt(identifier, password);
        }

        if (!handled) {
          let msg = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙØ´Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Firebase.";
          if (err.code === "auth/user-not-found") {
            msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Firebase.";
          } else if (err.code === "auth/wrong-password") {
            msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ù…Ù† Firebase).";
          } else if (err.code === "auth/invalid-login-credentials") {
            msg = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ù…Ù† Firebase).";
          }
          errorEl.textContent = msg + " Ù„Ùˆ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø³ØªÙ…Ø±Ø©ØŒ Ø±Ø§Ø¬Ø¹ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
        }
      }
    });
  }

  // ===== Ø²Ø± "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ" =====
  if (forgotBtn) {
    forgotBtn.addEventListener("click", async () => {
      errorEl.textContent = "";

      const identifier = (userEl.value || "").trim(); // username Ø£Ùˆ Ø¥ÙŠÙ…ÙŠÙ„

      if (!identifier) {
        errorEl.textContent = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§.";
        return;
      }

      let resetEmail = identifier;

      if (!identifier.includes("@")) {
        const appUser = findUserByIdentifier(identifier);
        if (!appUser || !appUser.email) {
          errorEl.textContent =
            "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
          return;
        }
        resetEmail = appUser.email;
      }

      try {
        await sendPasswordResetEmail(auth, resetEmail);
        errorEl.style.color = "#bbf7d0";
        errorEl.textContent =
          "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥Ù† ÙƒØ§Ù† Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Firebase).";
      } catch (err) {
        console.error("reset error:", err);
        errorEl.style.color = "#ff8080";
        let msg = "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        if (err.code === "auth/user-not-found") {
          msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Firebase.";
        } else if (err.code === "auth/invalid-email") {
          msg = "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­.";
        }
        errorEl.textContent = msg;
      } finally {
        setTimeout(() => {
          errorEl.style.color = "#ff8080";
        }, 6000);
      }
    });
  }

  // ===== ÙƒÙˆØ¯ ÙÙˆØ±Ù… "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" â†’ Ø­ÙØ¸ ÙÙŠ Firestore =====
  const OPEN_SIGNUP_BTN  = document.getElementById("openSignup");
  const SIGNUP_OVERLAY   = document.getElementById("signupOverlay");
  const CLOSE_SIGNUP_BTN = document.getElementById("closeSignup");
  const SIGNUP_FORM      = document.getElementById("signupForm");

  function openSignup() {
    if (SIGNUP_OVERLAY) SIGNUP_OVERLAY.style.display = "flex";
  }
  function closeSignup() {
    if (SIGNUP_OVERLAY) SIGNUP_OVERLAY.style.display = "none";
  }

  if (OPEN_SIGNUP_BTN && SIGNUP_OVERLAY) {
    OPEN_SIGNUP_BTN.addEventListener("click", openSignup);
  }
  if (CLOSE_SIGNUP_BTN) {
    CLOSE_SIGNUP_BTN.addEventListener("click", closeSignup);
  }

  if (SIGNUP_FORM) {
    SIGNUP_FORM.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!SIGNUP_FORM.checkValidity()) {
        SIGNUP_FORM.reportValidity();
        return;
      }

      const username = (document.getElementById("su_username").value || "").trim();
      const email    = (document.getElementById("su_email").value || "").trim();
      const phone    = (document.getElementById("su_phone").value || "").trim();
      const message  = (document.getElementById("su_message").value || "").trim();
      // Ù‡Ù†Ø·Ù†Ù‘Ø´ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù‡Ù†Ø§ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†ØŒ ÙˆØªØªØ¹Ø§Ù…Ù„ ÙƒØ¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
      // const password = document.getElementById("su_password").value || "";

      if (!username || !email) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„).");
        return;
      }

      try {
        await addDoc(collection(db, "signup_requests"), {
          username,
          email,
          phone,
          message,
          status: "pending",
          createdAt: serverTimestamp()
        });

        SIGNUP_FORM.reset();
        closeSignup();

        if (errorEl) {
          errorEl.style.color = "#bbf7d0";
          errorEl.textContent =
            "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ù‚ÙØ¨ÙÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….";
          setTimeout(() => {
            errorEl.style.color = "#ff8080";
            errorEl.textContent = "";
          }, 7000);
        } else {
          alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ù‚ÙØ¨ÙÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….");
        }
      } catch (err) {
        console.error("signup request error:", err);
        alert("ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
      }
    });
  }
</script>
</body>
</html>
