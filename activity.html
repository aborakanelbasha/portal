<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· | Ø¨ÙˆØ§Ø¨Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{
      --bg: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      --panel: rgba(15,23,42,.96);
      --border: rgba(30,64,175,.7);
      --border-soft: rgba(51,65,85,.9);
      --text: #e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.16);
      --danger:#f97373;
      --danger-soft:rgba(248,113,113,.12);
      --success:#4ade80;
      --success-soft:rgba(22,163,74,.18);
      --warning:#fbbf24;
      --warning-soft:rgba(245,158,11,.16);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:'Segoe UI',system-ui,Tahoma;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:18px 14px 40px;
    }

    .shell{
      max-width:1200px;
      margin:0 auto;
    }

    /* ===== Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©) ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:18px;
    }

    .topbar-title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .topbar-title h1{
      margin:0;
      font-size:1.6rem;
      letter-spacing:.03em;
    }

    .topbar-sub{
      margin:0;
      font-size:.87rem;
      color:var(--muted);
    }

    .user-chip{
      padding:9px 12px;
      border-radius:999px;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.7);
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.83rem;
      box-shadow:0 16px 40px rgba(15,23,42,.8);
      white-space:nowrap;
    }

    .user-dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background:var(--success);
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .user-chip span strong{
      font-weight:600;
    }

    /* ===== Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† ===== */
    .top-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-bottom:14px;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.75);
      background:rgba(15,23,42,.96);
      color:var(--text);
      padding:7px 14px;
      cursor:pointer;
      font-size:.83rem;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{
      box-shadow:0 0 0 1px rgba(56,189,248,.7);
    }

    .btn-danger{
      border-color:#fecaca;
      background:var(--danger-soft);
      color:#fecaca;
    }
    .btn-danger:hover{
      box-shadow:0 0 0 1px rgba(248,113,113,.8);
    }

    /* ===== ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
      margin-bottom:16px;
    }

    .stat-card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid rgba(31,41,55,.9);
      padding:10px 12px;
      box-shadow:0 14px 34px rgba(15,23,42,.85);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:70px;
    }

    .stat-label{
      font-size:.78rem;
      color:var(--muted);
    }

    .stat-value{
      font-size:1.1rem;
      font-weight:700;
    }

    .stat-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 9px;
      border-radius:999px;
      font-size:.72rem;
      border:1px solid rgba(148,163,184,.65);
      align-self:flex-start;
    }

    .stat-pill.success{
      border-color:var(--success);
      background:var(--success-soft);
      color:#bbf7d0;
    }

    .stat-pill.info{
      border-color:var(--accent);
      background:var(--accent-soft);
      color:#bae6fd;
    }

    .stat-pill.warn{
      border-color:var(--warning);
      background:var(--warning-soft);
      color:#fef3c7;
    }

    /* ===== Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± ===== */
    .filters-bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .search-box{
      flex:1;
      min-width:190px;
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      background:rgba(15,23,42,.9);
    }

    .search-box input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:.82rem;
      text-align:right;
    }

    .search-box input::placeholder{
      color:#6b7280;
    }

    .filter-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      border:1px solid rgba(75,85,99,.9);
      background:rgba(15,23,42,.92);
      color:var(--muted);
      padding:5px 10px;
      font-size:.78rem;
      cursor:pointer;
    }
    .chip.active{
      border-color:var(--accent);
      color:#e0f2fe;
      background:var(--accent-soft);
    }

    /* ===== Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø¬Ø¯ÙˆÙ„) ===== */
    .panel{
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 20px 55px rgba(15,23,42,.9);
      overflow:hidden;
    }

    .panel-header{
      padding:10px 14px 8px;
      border-bottom:1px solid var(--border-soft);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:.85rem;
    }

    .panel-header-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .panel-header-title strong{
      font-size:.9rem;
    }

    .panel-header-title span{
      font-size:.78rem;
      color:var(--muted);
    }

    .panel-header-meta{
      font-size:.78rem;
      color:var(--muted);
    }

    .table-wrap{
      max-height:64vh;
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
      direction:rtl;
    }

    thead{
      background:rgba(15,23,42,1);
    }

    th,td{
      padding:7px 6px;
      border-bottom:1px solid var(--border-soft);
      vertical-align:top;
      text-align:right;
    }

    th{
      position:sticky;
      top:0;
      z-index:1;
      background:rgba(15,23,42,.98);
      font-weight:600;
      color:#e5e7eb;
      font-size:.78rem;
    }

    tbody tr:nth-child(even){
      background:rgba(15,23,42,.9);
    }

    tbody tr:hover{
      background:rgba(30,64,175,.65);
    }

    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      direction:ltr;
      text-align:left;
    }

    .time-cell{
      white-space:nowrap;
    }

    .small{
      font-size:.74rem;
    }

    .tag-role{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      font-size:.72rem;
      color:#e5e7eb;
      background:rgba(15,23,42,.96);
    }

    .type-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 9px;
      border-radius:999px;
      font-size:.72rem;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.98);
      color:#e5e7eb;
    }

    .type-pill[data-kind="login"]{
      border-color:var(--success);
      background:var(--success-soft);
      color:#bbf7d0;
    }
    .type-pill[data-kind="portal"]{
      border-color:var(--warning);
      background:var(--warning-soft);
      color:#fef9c3;
    }
    .type-pill[data-kind="permit"]{
      border-color:var(--accent);
      background:var(--accent-soft);
      color:#bae6fd;
    }

    .empty-row td{
      text-align:center;
      padding:24px 8px;
      color:var(--muted);
      font-size:.86rem;
    }

    .error-box{
      padding:7px 10px;
      border-top:1px solid rgba(127,29,29,.9);
      background:var(--danger-soft);
      color:#fecaca;
      font-size:.76rem;
    }

    @media(max-width:860px){
      .topbar{
        flex-direction:column;
        align-items:flex-start;
      }
      .user-chip{
        align-self:stretch;
        justify-content:space-between;
      }
    }

    @media(max-width:640px){
      body{padding:12px 10px 30px;}
      .panel-header{
        flex-direction:column;
        align-items:flex-start;
      }
      th:nth-child(1),
      td:nth-child(1){
        display:none;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ===== ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØµÙØ­Ø© / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== -->
    <div class="topbar">
      <div class="topbar-title">
        <h1>Ù„ÙˆØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h1>
        <p class="topbar-sub">
          Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
        </p>
      </div>

      <div class="user-chip" id="userChip">
        <span class="user-dot"></span>
        <span id="userChipText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…â€¦</span>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="top-actions">
      <button class="btn" type="button" onclick="goPortal()">
        â¬…ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©
      </button>
      <button class="btn" type="button" onclick="clearLocalLog()">
        ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­
      </button>
      <button class="btn btn-danger" type="button" onclick="clearServerLog()">
        âš ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… (Firestore)
      </button>
    </div>

    <!-- ÙƒØ±ÙˆØª Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
        <div class="stat-value" id="statTotal">0</div>
        <span class="stat-pill info">
          ğŸ” Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©
        </span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø£Ø­Ø¯Ø§Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        <div class="stat-value" id="statLogin">0</div>
        <span class="stat-pill success">
          ğŸ‘¤ Ø¯Ø®ÙˆÙ„ / Ø®Ø±ÙˆØ¬
        </span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø­Ø±ÙƒØ§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</div>
        <div class="stat-value" id="statPortal">0</div>
        <span class="stat-pill warn">
          ğŸ§­ ÙØªØ­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© / ØªØºÙŠÙŠØ± Ù…Ø´Ø±ÙˆØ¹
        </span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø­Ø±ÙƒØ§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ØªØµØ§Ø±ÙŠØ­</div>
        <div class="stat-value" id="statPermits">0</div>
        <span class="stat-pill info">
          ğŸ“„ ÙØªØ­ ÙˆØªØµØ§Ø±ÙŠØ­
        </span>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filters-bar">
      <div class="search-box">
        <span class="small">ğŸ”</span>
        <input
          id="searchInput"
          type="text"
          placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„â€¦"
        />
      </div>
      <div class="filter-chips">
        <button class="chip active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-filter="login">Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬</button>
        <button class="chip" data-filter="portal">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</button>
        <button class="chip" data-filter="permit">Ø§Ù„ØªØµØ§Ø±ÙŠØ­</button>
        <button class="chip" data-filter="other">Ø£Ø®Ø±Ù‰</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-header-title">
          <strong>Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©</strong>
          <span id="panelSub">ÙŠØ¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</span>
        </div>
        <div class="panel-header-meta">
          Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong id="eventsCount">0</strong> Ø­Ø±ÙƒØ©
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</th>
              <th>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <tr class="empty-row">
              <td colspan="6">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="errorBox" class="error-box" style="display:none;"></div>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Firestore (activity-log) -->
  <script type="module" src="activity-log.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø¹Ø§Ù… (ØºÙŠØ± module) Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙˆØ§Ù„ ØªÙƒÙˆÙ† global -->
  <script>
    let CURRENT_USER = null;
    let currentFilter = "all";
    let currentSearch = "";

    // ===== Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (admin ÙÙ‚Ø·) =====
    (function protectActivityPage(){
      try{
        const raw = localStorage.getItem("aln_session");
        if (!raw){
          alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
          window.location.href = "/";
          return;
        }
        const session = JSON.parse(raw);
        if (!session || !session.username || !session.role){
          localStorage.removeItem("aln_session");
          alert("Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          window.location.href = "/";
          return;
        }

        if (String(session.role || "").toLowerCase() !== "admin"){
          alert("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (admin) ÙÙ‚Ø·.");
          window.location.href = "/portal";
          return;
        }

        CURRENT_USER = session;

        const chipTxt = document.getElementById("userChipText");
        if (chipTxt){
          chipTxt.innerHTML = `Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙƒÙ€ <strong>${session.username}</strong> â€” Ø§Ù„Ø¯ÙˆØ±: <strong>${session.role}</strong>`;
        }
      }catch(e){
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
        window.location.href = "/";
      }
    })();

    function goPortal(){
      window.location.href = "/portal";
    }

    function formatTime(iso){
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("ar-EG");
    }

    function classifyType(type){
      const t = (type || "").toUpperCase();
      if (t.startsWith("LOGIN") || t === "LOGOUT") return "login";
      if (t.startsWith("PERMIT") || t === "OPEN_PERMIT") return "permit";
      if (t === "PORTAL_OPEN" || t === "SWITCH_PROJECT") return "portal";
      return "other";
    }

    function applyFilters(){
      const rows = document.querySelectorAll("#logBody tr[data-kind]");
      const search = currentSearch.trim().toLowerCase();

      rows.forEach(row => {
        const kind  = row.dataset.kind || "other";
        const text  = row.dataset.text || "";
        let ok = true;

        if (currentFilter !== "all" && kind !== currentFilter){
          ok = false;
        }

        if (ok && search){
          if (!text.includes(search)){
            ok = false;
          }
        }

        row.style.display = ok ? "" : "none";
      });
    }

    async function loadLog(){
      const tbody    = document.getElementById("logBody");
      const countEl  = document.getElementById("eventsCount");
      const errorBox = document.getElementById("errorBox");
      const panelSub = document.getElementById("panelSub");

      if (!tbody) return;

      errorBox.style.display = "none";
      errorBox.textContent   = "";
      panelSub.textContent   = "ÙŠØ¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦";

      let list = [];

      try{
        if (window.fetchActivityLog){
          list = await window.fetchActivityLog();
        }else{
          const raw = localStorage.getItem("ptw_activity_log");
          list = raw ? (JSON.parse(raw) || []) : [];
        }
      }catch(e){
        console.error("Error loading activity log:", e);
        errorBox.style.display = "block";
        errorBox.textContent = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø£ÙŠ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ù…ØªÙˆÙØ± (Ø¥Ù† ÙˆØ¬Ø¯).";

        try{
          const raw = localStorage.getItem("ptw_activity_log");
          list = raw ? (JSON.parse(raw) || []) : [];
        }catch(_){}
      }

      if (!Array.isArray(list)) list = [];

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      list = list.slice().sort((a,b)=>{
        const ta = a.time || "";
        const tb = b.time || "";
        return ta < tb ? 1 : -1;
      });

      // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      let total = list.length;
      let loginCount = 0, portalCount = 0, permitCount = 0;

      tbody.innerHTML = "";

      if (!list.length){
        const tr = document.createElement("tr");
        tr.className = "empty-row";
        tr.innerHTML = `<td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.</td>`;
        tbody.appendChild(tr);

        if (countEl) countEl.textContent = "0";
        if (panelSub) panelSub.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù‘Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
      }else{
        list.forEach((item, index) => {
          const kind = classifyType(item.type);
          if (kind === "login")  loginCount++;
          if (kind === "portal") portalCount++;
          if (kind === "permit") permitCount++;

          const detailsText = item.details ? JSON.stringify(item.details) : "";
          const searchText  = [
            item.user || "",
            item.role || "",
            item.type || "",
            detailsText
          ].join(" ").toLowerCase();

          const tr = document.createElement("tr");
          tr.dataset.kind = kind;
          tr.dataset.text = searchText;

          tr.innerHTML = `
            <td class="small">${index + 1}</td>
            <td class="time-cell small mono">${formatTime(item.time)}</td>
            <td class="small">${item.user || "-"}</td>
            <td class="small">
              <span class="tag-role">
                <span>ğŸ¯</span>
                <span>${item.role || "-"}</span>
              </span>
            </td>
            <td class="small">
              <span class="type-pill" data-kind="${kind}">
                ${item.type || "-"}
              </span>
            </td>
            <td class="mono small">${detailsText}</td>
          `;
          tbody.appendChild(tr);
        });

        if (countEl) countEl.textContent = String(total);
        if (panelSub) panelSub.textContent = "Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø±ØªÙ‘Ø¨Ø© Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù….";
      }

      // Ø¶Ø¨Ø· Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      document.getElementById("statTotal").textContent   = String(total);
      document.getElementById("statLogin").textContent   = String(loginCount);
      document.getElementById("statPortal").textContent  = String(portalCount);
      document.getElementById("statPermits").textContent = String(permitCount);

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
      applyFilters();
    }

    async function clearServerLog(){
      if (!window.clearActivityLog){
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù…Ù„Ù activity-log ØºÙŠØ± Ù…ØªØ§Ø­.");
        return;
      }
      if (!confirm("âš  Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… (Firestore)ØŸ")) return;

      try{
        await window.clearActivityLog();
        await loadLog();
        alert("ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….");
      }catch(e){
        console.error("clearServerLog error:", e);
        alert("ØªØ¹Ø°Ø± Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.");
      }
    }

    function clearLocalLog(){
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·ØŸ")) return;
      localStorage.removeItem("ptw_activity_log");
      loadLog();
    }

    // ===== Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ± Ùˆ Ø§Ù„Ø¨Ø­Ø« =====
    document.addEventListener("DOMContentLoaded", () => {
      loadLog();

      const searchInput = document.getElementById("searchInput");
      if (searchInput){
        searchInput.addEventListener("input", (e)=>{
          currentSearch = e.target.value || "";
          applyFilters();
        });
      }

      document.querySelectorAll(".chip[data-filter]").forEach(chip=>{
        chip.addEventListener("click", ()=>{
          const f = chip.dataset.filter || "all";
          currentFilter = f;
          document.querySelectorAll(".chip[data-filter]").forEach(c=>{
            c.classList.toggle("active", c === chip);
          });
          applyFilters();
        });
      });
    });
  </script>
</body>
</html>
